---
import Navigation from '../components/Navigation.astro';
import MobileMenu from '../components/MobileMenu.astro';
import Footer from '../components/Footer.astro';
import fs from 'fs';
import path from 'path';

// Naƒçten√≠ PDF soubor≈Ø z podslo≈æek podle roku
const liturgicalTextsDir = path.join(process.cwd(), 'public', 'liturgical_texts');
let pdfsByYear: Record<string, Array<{fileName: string, filePath: string}>> = {};

try {
  if (fs.existsSync(liturgicalTextsDir)) {
    const yearDirs = fs.readdirSync(liturgicalTextsDir, { withFileTypes: true })
      .filter(dirent => dirent.isDirectory());
    
    yearDirs.forEach(yearDir => {
      const year = yearDir.name;
      const yearPath = path.join(liturgicalTextsDir, year);
      
      if (fs.existsSync(yearPath)) {
        const files = fs.readdirSync(yearPath);
        const pdfFiles = files.filter(file => file.toLowerCase().endsWith('.pdf'));
        
        if (pdfFiles.length > 0) {
          pdfsByYear[year] = pdfFiles.map(file => ({
            fileName: file,
            filePath: `${year}/${file}`
          })).sort((a, b) => b.fileName.localeCompare(a.fileName));
        }
      }
    });
    
    // Se≈ôazen√≠ let sestupnƒõ (nejnovƒõj≈°√≠ prvn√≠)
    const sortedYears = Object.keys(pdfsByYear).sort((a, b) => {
      if (a === 'Ostatn√≠' || a === 'other' || a === 'Other') return 1;
      if (b === 'Ostatn√≠' || b === 'other' || b === 'Other') return -1;
      
      const yearA = parseInt(a, 10);
      const yearB = parseInt(b, 10);
      
      if (isNaN(yearA) && isNaN(yearB)) return b.localeCompare(a);
      if (isNaN(yearA)) return -1;
      if (isNaN(yearB)) return 1;
      
      return yearB - yearA;
    });
    
    pdfsByYear = sortedYears.reduce((obj, key) => {
      obj[key] = pdfsByYear[key];
      return obj;
    }, {} as Record<string, Array<{fileName: string, filePath: string}>>);
  }
} catch (error) {
  console.error('Chyba p≈ôi naƒç√≠t√°n√≠ PDF soubor≈Ø:', error);
}

// Z√≠sk√°n√≠ aktu√°ln√≠ho roku a rozdƒõlen√≠ dat
const currentYear = new Date().getFullYear().toString();
const allYears = Object.keys(pdfsByYear);
const currentYearData = pdfsByYear[currentYear] || [];
// Obr√°cen√≠ po≈ôad√≠ let - od nejstar≈°√≠ho k aktu√°ln√≠mu
const otherYears = allYears.filter(year => year !== currentYear).reverse();
---

<!doctype html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Liturgie - Farnost Hroch≈Øv T√Ωnec - Chroustovice</title>
    <meta name="description" content="Liturgick√© texty, kalend√°≈ô a zdroje pro farnost Hroch≈Øv T√Ωnec - Chroustovice." />
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    
    <!-- Preload fonts -->
    <link rel="preload" href="/fonts/Ohrada.otf" as="font" type="font/otf" crossorigin="anonymous" />
    <link rel="preload" href="/fonts/HelveticaNow.otf" as="font" type="font/otf" crossorigin="anonymous" />
    <link rel="preload" href="/fonts/HelveticaNowBold.otf" as="font" type="font/otf" crossorigin="anonymous" />
    <link rel="preload" href="/fonts/OpenSans-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
    <link rel="preload" href="/fonts/OpenSans-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
    <link rel="stylesheet" href="/styles_v2.css" />
  </head>

  <body>
    <MobileMenu />
    
    <header class="site-header">
      <div class="header-content">
        <a href="/" class="header-favicon" aria-label="P≈ôej√≠t na domovskou str√°nku">
          <img src="/favicon/apple-touch-icon.png" alt="Logo farnosti" />
        </a>
        <div class="header-text">
          <h1>Farnost Hroch≈Øv T√Ωnec - Chroustovice</h1>
          <p>≈ò√≠mskokatolick√° farnost</p>
        </div>
      </div>
    </header>

    <Navigation />

    <div class="content">
      <div class="container">
        <!-- Liturgick√© texty ke sta≈æen√≠ -->
        <h1 class="page-title">Bo≈æ√≠ slovo</h1>
        <div class="liturgical-files-section">
          
          {Object.keys(pdfsByYear).length === 0 ? (
            <div class="no-files">
              <p>Zat√≠m nejsou k dispozici ≈æ√°dn√© liturgick√© texty ke sta≈æen√≠.</p>
            </div>
          ) : (
            <>
              <div class="files-by-year">
                <!-- Aktu√°ln√≠ rok - v≈ædy viditeln√Ω -->
                {currentYearData.length > 0 ? (
                  <div class="year-group" data-year={currentYear}>
                    <h4 class="year-header">{currentYear}</h4>
                    <div class="files-grid">
                      {currentYearData.map(({fileName, filePath}) => {
                        const displayName = fileName
                          .replace('.pdf', '')
                          .replace(/^\d{4}-\d{2}-\d{2}[-_]?/, '')
                          .replace(/[-_]/g, ' ')
                          .trim();
                        
                        return (
                          <div class="file-item">
                            <div class="file-info">
                              <span class="file-icon">üìÑ</span>
                              <span class="file-name">{displayName}</span>
                            </div>
                            <div class="file-actions">
                              <a 
                                href={`/liturgical_texts/${filePath}`} 
                                target="_blank" 
                                rel="noopener noreferrer"
                                class="file-btn view-btn"
                                aria-label={`Zobrazit ${displayName}`}
                              >
                                üëÅÔ∏è Zobrazit
                              </a>
                              <a 
                                href={`/liturgical_texts/${filePath}`} 
                                download
                                class="file-btn download-btn"
                                aria-label={`St√°hnout ${displayName}`}
                              >
                                ‚¨áÔ∏è St√°hnout
                              </a>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ) : allYears.length > 0 && (
                  <div class="year-group" data-year={allYears[0]}>
                    <h4 class="year-header">{allYears[0]}</h4>
                    <div class="files-grid">
                      {pdfsByYear[allYears[0]].map(({fileName, filePath}) => {
                        const displayName = fileName
                          .replace('.pdf', '')
                          .replace(/^\d{4}-\d{2}-\d{2}[-_]?/, '')
                          .replace(/[-_]/g, ' ')
                          .trim();
                        
                        return (
                          <div class="file-item">
                            <div class="file-info">
                              <span class="file-icon">üìÑ</span>
                              <span class="file-name">{displayName}</span>
                            </div>
                            <div class="file-actions">
                              <a 
                                href={`/liturgical_texts/${filePath}`} 
                                target="_blank" 
                                rel="noopener noreferrer"
                                class="file-btn view-btn"
                                aria-label={`Zobrazit ${displayName}`}
                              >
                                üëÅÔ∏è Zobrazit
                              </a>
                              <a 
                                href={`/liturgical_texts/${filePath}`} 
                                download
                                class="file-btn download-btn"
                                aria-label={`St√°hnout ${displayName}`}
                              >
                                ‚¨áÔ∏è St√°hnout
                              </a>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                <!-- Skryt√© star≈°√≠ roky -->
                {otherYears.length > 0 && (
                  <div class="extra-items-container" id="extraYears">
                    {otherYears.map((year) => (
                      <div class="year-group" data-year={year}>
                        <h4 class="year-header">{year}</h4>
                        <div class="files-grid">
                          {pdfsByYear[year].map(({fileName, filePath}) => {
                            const displayName = fileName
                              .replace('.pdf', '')
                              .replace(/^\d{4}-\d{2}-\d{2}[-_]?/, '')
                              .replace(/[-_]/g, ' ')
                              .trim();
                            
                            return (
                              <div class="file-item">
                                <div class="file-info">
                                  <span class="file-icon">üìÑ</span>
                                  <span class="file-name">{displayName}</span>
                                </div>
                                <div class="file-actions">
                                  <a 
                                    href={`/liturgical_texts/${filePath}`} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    class="file-btn view-btn"
                                    aria-label={`Zobrazit ${displayName}`}
                                  >
                                    üëÅÔ∏è Zobrazit
                                  </a>
                                  <a 
                                    href={`/liturgical_texts/${filePath}`} 
                                    download
                                    class="file-btn download-btn"
                                    aria-label={`St√°hnout ${displayName}`}
                                  >
                                    ‚¨áÔ∏è St√°hnout
                                  </a>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              <!-- Tlaƒç√≠tko pro naƒçten√≠ star≈°√≠ch let -->
              {otherYears.length > 0 && (
                <div class="pagination">
                  <button class="load-more-btn" id="toggleExtraYears">
                    <span class="btn-text" id="btnText">
                      <span>üìÖ Zobrazit star≈°√≠ roky</span>
                      <span class="count">+{otherYears.length}</span>
                    </span>
                  </button>
                </div>
              )}
            </>
          )}
        </div>
      </div>
    </div>

    <button id="scrollTopBtn" aria-label="Zpƒõt nahoru"></button>
    <script type="module" src="/script.js" defer></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const toggleBtn = document.getElementById('toggleExtraYears');
        const extraYears = document.getElementById('extraYears');
        const btnText = document.getElementById('btnText');

        if (toggleBtn && extraYears) {
          toggleBtn.addEventListener('click', () => {
            const isOpen = extraYears.classList.toggle('is-open');
            
            if (isOpen) {
              btnText.innerHTML = '<span>‚ñ≤ Zobrazit m√©nƒõ</span>';
            } else {
              const yearCount = extraYears.querySelectorAll('.year-group').length;
              btnText.innerHTML = '<span>üìÖ Zobrazit star≈°√≠ roky</span><span class="count">+' + yearCount + '</span>';
              
              extraYears.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }
          });
        }
      });
    </script>
    <Footer />
  </body>
</html>
